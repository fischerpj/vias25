-- list-images.lua
-- Guaranteed-working version using CodeBlock â†’ Table replacement

local function is_jpg(name)
  local ext = name:match("%.([^%.]+)$")
  return ext and ext:lower() == "jpg"
end

function CodeBlock(el)
  -- Only process ```{image-table}
  if el.classes[1] ~= "image-table" then
    return nil
  end

  local folder = "agde25"
  local width  = "120"

  -- Try listing files
  local ok, files = pcall(pandoc.system.list_directory, folder)
  if not ok then
    return pandoc.Para("Error: folder '" .. folder .. "' not found.")
  end

  -- Collect rows
  local rows = {}
  for _, f in ipairs(files) do
    if is_jpg(f) then
      local path = folder .. "/" .. f
      local thumb = pandoc.Image({pandoc.Str("")}, path, "", {width = width})
      table.insert(rows, {pandoc.Str(f), thumb})
    end
  end

  if #rows == 0 then
    return pandoc.Para("No JPG images found in folder '" .. folder .. "'.")
  end

  -- Build a Pandoc table (never escapes, always renders)
  local headers = {
    pandoc.Str("File"),
    pandoc.Str("Thumbnail")
  }

  return pandoc.Table(
    "",          -- caption
    {headers},   -- table head
    rows,        -- table body
    {},          -- foot
    pandoc.TableAttr{}
  )
end
